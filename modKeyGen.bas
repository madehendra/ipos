Attribute VB_Name = "modKeyGen"
Public Function GetToken(ByVal obj As CodeSuiteLibrary.Data) As String
Dim cSQL As String
Dim db As New ADODB.Recordset
Dim dTglkey As Date

  GetToken = "NULL"
  cSQL = " select * from keyapp where keyapp = '" & GetRegistry(reg_KeySecret) & "'"
  cSQL = cSQL & " ORDER BY id DESC LIMIT 0,1"
  
  Set db = obj.SQL(GetDSN, cSQL)
  If Not db.EOF Then
    If IsDate(CryptRC4(FromHexDump(GetNull(db!tokenapp)), GetRegistry(reg_KeySecret))) = True Then
      GetToken = GetNull(db!tokenapp)
    End If
  End If
End Function

Public Function CryptRC4(sText As String, sKey As String) As String
    Dim baS(0 To 255) As Byte
    Dim baK(0 To 255) As Byte
    Dim bytSwap     As Byte
    Dim lI          As Long
    Dim lJ          As Long
    Dim lIdx        As Long

    For lIdx = 0 To 255
        baS(lIdx) = lIdx
        baK(lIdx) = Asc(Mid$(sKey, 1 + (lIdx Mod Len(sKey)), 1))
    Next
    For lI = 0 To 255
        lJ = (lJ + baS(lI) + baK(lI)) Mod 256
        bytSwap = baS(lI)
        baS(lI) = baS(lJ)
        baS(lJ) = bytSwap
    Next
    lI = 0
    lJ = 0
    For lIdx = 1 To Len(sText)
        lI = (lI + 1) Mod 256
        lJ = (lJ + baS(lI)) Mod 256
        bytSwap = baS(lI)
        baS(lI) = baS(lJ)
        baS(lJ) = bytSwap
        CryptRC4 = CryptRC4 & Chr$((pvCryptXor(baS((CLng(baS(lI)) + baS(lJ)) Mod 256), Asc(Mid$(sText, lIdx, 1)))))
    Next
End Function

Private Function pvCryptXor(ByVal lI As Long, ByVal lJ As Long) As Long
    If lI = lJ Then
        pvCryptXor = lJ
    Else
        pvCryptXor = lI Xor lJ
    End If
End Function

Public Function ToHexDump(sText As String) As String
    Dim lIdx            As Long

    For lIdx = 1 To Len(sText)
        ToHexDump = ToHexDump & Right$("0" & Hex(Asc(Mid(sText, lIdx, 1))), 2)
    Next
End Function

Public Function FromHexDump(sText As String) As String
    Dim lIdx            As Long

    For lIdx = 1 To Len(sText) Step 2
        FromHexDump = FromHexDump & Chr$(CLng("&H" & Mid(GetNull(sText), lIdx, 2)))
    Next
End Function
